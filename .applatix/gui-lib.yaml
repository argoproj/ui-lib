---
type: service_template
subtype: workflow
name: gui-lib-build
description: This is the workflow for building Ax Portal API.
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    appname:
      default: "gui-lib"
    deployname:
      default: "gui-lib-deploy"
    domain:
      default: "gui-lib.applatix.net"
steps:
- checkout:
    template: axscm-checkout
- build:
    template: node
    parameters:
      cmd: "sh -c 'cd /src && npm install --no-optional && npm run tslint && npm run build:prod'"
      code: "%%steps.checkout.code%%"
    outputs:
    artifacts:
      code:
        path: "/src"
- deploy:
    template: gui-lib-deployment
    parameters:
      code: "%%steps.build.code%%"

---
type: deployment
name: gui-lib-deployment
inputs:
  parameters:
    code:
      default: "%%session.artifacts%%"
    appname:
    deployname:
    domain:
application:
  name: "%%appname%%"
deployment:
  name: "%%deployname%%"
scale:
  min: 1
external_routes:
  - name: "gui-lib-ui"
    dns_prefix: "examples"
    dns_domain: "%%domain%%"
    target_port: 8080
    redirect_http_to_https: false
    ip_white_list:
      - 0.0.0.0/0
containers:
  - server:
      template: node
      parameters:
        cmd: sh -c 'cd /src && npm run server:prod'
termination_policy:
  time_seconds: "43200"
  spending_cents: "100"

---
type: policy
name: gui-lib-build-policy
description: Policy for GUI library build
template: gui-lib-build
parameters:
  repo: ""
  commit: ""
  branch: ""
  testOnly: "true"
notifications:
  -
    when:
      - on_change
    whom:
      - committer
      - submitter
      - author
when:
  -
    event: on_pull_request
    target_branches:
      - master
  -
    event: on_push
    target_branches:
      - master
